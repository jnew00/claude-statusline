#!/bin/bash
# claude-plan-usage-status
#
# Reads ~/.claude/plan-usage.json and prints a single-line status
# suitable for shell prompts or tmux statusline.
#
# Output format: C5h:34% Wk:62%
#
# Options:
#   --json     Output the raw JSON instead of formatted string
#   --verbose  Include fetch timestamp
#   --stale N  Mark as stale if data is older than N minutes (default: 30)
#
# Exit codes:
#   0 - Success
#   1 - File not found or unreadable
#   2 - JSON parse error
#   3 - Data is stale (when --stale is used with threshold exceeded)

set -euo pipefail

USAGE_FILE="${HOME}/.claude/plan-usage.json"
STALE_MINUTES=30
OUTPUT_JSON=false
VERBOSE=false

# Parse arguments
while [[ $# -gt 0 ]]; do
  case "$1" in
    --json)
      OUTPUT_JSON=true
      shift
      ;;
    --verbose)
      VERBOSE=true
      shift
      ;;
    --stale)
      STALE_MINUTES="$2"
      shift 2
      ;;
    --help|-h)
      echo "Usage: claude-plan-usage-status [--json] [--verbose] [--stale N]"
      echo ""
      echo "Options:"
      echo "  --json     Output raw JSON"
      echo "  --verbose  Include fetch timestamp"
      echo "  --stale N  Consider data stale after N minutes (default: 30)"
      exit 0
      ;;
    *)
      echo "Unknown option: $1" >&2
      exit 1
      ;;
  esac
done

# Check if file exists
if [[ ! -f "$USAGE_FILE" ]]; then
  echo "C:--"
  exit 1
fi

# Check if jq is available
if ! command -v jq &> /dev/null; then
  # Fallback: basic parsing without jq
  five_hour=$(grep -o '"five_hour_percent":[^,}]*' "$USAGE_FILE" | sed 's/.*://' | tr -d ' ')
  weekly=$(grep -o '"weekly_percent":[^,}]*' "$USAGE_FILE" | sed 's/.*://' | tr -d ' ')

  if [[ "$five_hour" == "null" ]]; then five_hour="--"; fi
  if [[ "$weekly" == "null" ]]; then weekly="--"; fi

  echo "C5h:${five_hour}% Wk:${weekly}%"
  exit 0
fi

# Parse JSON with jq
if ! data=$(jq -r '.' "$USAGE_FILE" 2>/dev/null); then
  echo "C:ERR"
  exit 2
fi

# Output raw JSON if requested
if [[ "$OUTPUT_JSON" == "true" ]]; then
  echo "$data"
  exit 0
fi

# Extract values
five_hour=$(echo "$data" | jq -r '.five_hour_percent // "--"')
weekly=$(echo "$data" | jq -r '.weekly_percent // "--"')
resets_in=$(echo "$data" | jq -r '.resets_in // ""')
fetched_at=$(echo "$data" | jq -r '.fetched_at // ""')

# Format percentages (remove decimal if whole number)
format_pct() {
  local val="$1"
  if [[ "$val" == "--" || "$val" == "null" ]]; then
    echo "--"
  elif [[ "$val" =~ \.0$ ]]; then
    echo "${val%.0}"
  else
    echo "$val"
  fi
}

five_hour_fmt=$(format_pct "$five_hour")
weekly_fmt=$(format_pct "$weekly")

# Check staleness if timestamp exists
stale_marker=""
if [[ -n "$fetched_at" && "$fetched_at" != "null" ]]; then
  # Convert ISO timestamp to epoch (macOS compatible)
  if fetched_epoch=$(date -j -f "%Y-%m-%dT%H:%M:%S" "${fetched_at%%.*}" "+%s" 2>/dev/null); then
    now_epoch=$(date "+%s")
    age_minutes=$(( (now_epoch - fetched_epoch) / 60 ))

    if [[ $age_minutes -gt $STALE_MINUTES ]]; then
      stale_marker="!"
    fi
  fi
fi

# Build output
output="C5h:${five_hour_fmt}% Wk:${weekly_fmt}%"

# Add reset time if available
if [[ -n "$resets_in" && "$resets_in" != "null" ]]; then
  output="${output} â±${resets_in}"
fi

output="${output}${stale_marker}"

if [[ "$VERBOSE" == "true" && -n "$fetched_at" && "$fetched_at" != "null" ]]; then
  # Format timestamp for display
  if display_time=$(date -j -f "%Y-%m-%dT%H:%M:%S" "${fetched_at%%.*}" "+%H:%M" 2>/dev/null); then
    output="${output} @${display_time}"
  fi
fi

echo "$output"
